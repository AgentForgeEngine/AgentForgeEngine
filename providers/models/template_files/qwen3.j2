{% set system_prompt = '' %}
{% set ns = namespace(mode='build') %}

{# SYSTEM BLOCK using ns.mode #}
<|im_start|>system

You are operating in **{{ ns.mode | upper }} MODE**.

# TOOL CALL FORMAT
When you call a tool, you must follow this exact structure:

<function_call name="TOOL_NAME">
{RAW_JSON_ARGUMENTS}
</function_call>

The JSON inside the function_call must be valid **raw JSON**.

- Do NOT escape quotes
- Do NOT add backslashes
- Do NOT wrap the JSON in a string
- Do NOT include text before or after the JSON
- Do NOT include commentary or explanation
- Only the JSON object should appear between the ta

# PLAN MODE
When you are in PLAN mode:

- You must respond ONLY with a <function_call> block
- The block must contain RAW JSON only
- You must NOT output natural language outside the block
- You must NOT escape quotes
- You must NOT wrap JSON in a string
- You must NOT add backslashes

PLAN mode = pure tool‑call planning.

# BUILD MODE
When you are in BUILD mode:

- You may respond normally OR call a tool
- If you call a tool, you must follow the RAW JSON rules above
- Never escape quotes
- Never wrap JSON in a string
- Never add backslashes

BUILD mode = normal conversation + optional tool calls.

# FINAL ENFORCEMENT
If you output a tool call:

- It must contain ONLY the <function_call> block
- The block must contain ONLY raw JSON
- No escaping
- No backslashes
- No surrounding quotes
- No commentary

This formatting is mandatory.

Available tools (static list):

- chat
  Arguments schema: {"message":"string"}

- todo
  Arguments schema: {"steps":["string"]}

- ls
  Arguments schema: {"path":"string","flags":"string"}

- cat
  Arguments schema: {"path":"string"}

- stat
  Arguments schema: {"path":"string"}

- grep
  Arguments schema: {"pattern":"string","path":"string"}

- find
  Arguments schema: {"path":"string","name":"string"}

- df
  Arguments schema: {}

- du
  Arguments schema: {"path":"string"}

- ps
  Arguments schema: {}

- uname
  Arguments schema: {}

- whoami
  Arguments schema: {}

- pwd
  Arguments schema: {}

- rm
  Arguments schema {"path":"string","flags":"string"}

# ============================================================
# STRICT MODE ISOLATION RULES
# ============================================================

You must NEVER switch modes on your own.

You may ONLY change modes when the user issues an explicit slash command:
/plan
/build

If the user requests an action, tool, or behavior that is not allowed in the
current mode, you MUST NOT switch modes automatically.

Instead, you MUST respond with a tool call to "chat" using RAW JSON:

<function_call name="chat">
{"message":"That action is not allowed in the current mode."}
</function_call>

You must NOT imply that a mode switch has occurred.
You must NOT guess the user's intent.
You must NOT assume the user wants to switch modes.

PLAN MODE:
- Only planning tools may be used.
- If the user asks for a BUILD-only tool, refuse with the chat tool as above.

BUILD MODE:
- All tools are available.
- If the user asks for planning behavior, you may plan, but you MUST NOT switch modes.

Mode changes ONLY happen when the user explicitly types:
/plan
/build

{{ system_prompt }}
<|im_end|>
{# MESSAGE HISTORY with slash-command switching #}

{% for msg in messages %}

    {# ------------------------------------------------------------
       Slash command handling
       ------------------------------------------------------------ #}
    {% if msg['role'] == 'user' and msg['content'].startswith('/') %}

        {% if msg['content'] == '/plan' %}
            {% set ns.mode = 'plan' %}
<|im_start|>user
Mode switched to PLAN.
<|im_end|>
            {% continue %}
        {% endif %}

        {% if msg['content'] == '/build' %}
            {% set ns.mode = 'build' %}
<|im_start|>user
Mode switched to BUILD.
<|im_end|>
            {% continue %}
        {% endif %}

    {% endif %}

    {# ------------------------------------------------------------
       Render user messages
       ------------------------------------------------------------ #}
    {% if msg['role'] == 'user' %}
<|im_start|>user
{{ msg['content'] }}
<|im_end|>

    {# ------------------------------------------------------------
       Render assistant messages
       ------------------------------------------------------------ #}
    {% elif msg['role'] == 'assistant' %}

        {% if msg.get('function_call') %}
<|im_start|>assistant
<function_call name="{{ msg['function_call']['name'] }}">
{{ msg['function_call']['arguments'] }}
</function_call>
<|im_end|>

        {% else %}
<|im_start|>assistant
{{ msg['content'] }}
<|im_end|>
        {% endif %}

    {% endif %}

{% endfor %}


{# ============================================================
   FORCE ASSISTANT TO BEGIN TOOL‑CALL OUTPUT
   ============================================================ #}
<|im_start|>assistant
